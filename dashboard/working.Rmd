---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(lubridate)
library(httr)
library(jsonlite)

lec_data <- read_csv(here::here("data/lec_data.csv")) %>% 
  mutate(game_id = as.factor(game_id))

lec_data_teams <- lec_data %>% 
  filter(is.na(player_name)) %>% 
  mutate(kda = ((kills + assists) / if_else(deaths == 0, 1, deaths))) %>% 
  relocate(kda, .after = assists) %>% 
  mutate(kda = round(kda, 2))

lec_data_players <- lec_data %>% 
  filter(!is.na(player_name)) %>% 
  mutate(kda = ((kills + assists) / if_else(deaths == 0, 1, deaths))) %>% 
  relocate(kda, .after = assists) %>% 
  mutate(kda = round(kda, 2))

```

```{r}
get_roster <- function(x_team){
  
  lec_data %>% 
    filter(!is.na(player_name), team_name == x_team) %>% 
    select(position, player_name, game_id) %>% 
    group_by(player_name) %>% 
    summarise(position, games = n_distinct(game_id)) %>% 
    distinct() %>% 
    ungroup() %>% 
    select(position, player_name, games) %>% 
    arrange(factor(position, levels = c("top", "mid", "bot", "sup", "jng")), player_name)
}

get_matches <- function(x_team){
  
  lec_data %>% 
    select(game_id, team_name) %>% 
    group_by(game_id) %>%
    filter(team_name == x_team) %>% 
    select(game_id) %>% 
    distinct() %>% 
    pull()
}

get_game_history <- function(x_team){
  
  team_games <- get_matches(x_team)
  
  lec_data %>% 
    select(game_id, date, split, playoffs, game, side, team_name, winner) %>% 
    filter(game_id %in% team_games, team_name != x_team) %>%
    distinct() %>% 
    mutate(winner = !winner) %>% 
    arrange(date, game)
}

get_match_history <- function(x_team, match_data){
  
  get_game_history(x_team) %>% 
    select(date, split, playoffs, game, team_name, winner) %>% 
    mutate(date = as.Date(date)) %>% 
    group_by(date) %>%
    count(team_name, playoffs, split, winner) %>% 
    pivot_wider(names_from = winner, values_from = n) %>% 
    rename(wins = `TRUE`, losses = `FALSE`) %>% 
    mutate(wins = coalesce(wins, 0), losses = coalesce(losses, 0),
           winner = if_else(wins > losses, TRUE, FALSE))
}

```

```{r}
no_games <- length(unique(na.omit(lec_data$game_id)))
no_teams <- length(unique(na.omit(lec_data$team_name)))
total_champs <- length(unique(na.omit(lec_data$champion)))
total_kills <- lec_data %>% 
  filter(is.na(player_name)) %>% 
  summarise(total_kills = sum(kills)) %>% 
  pull()
total_deaths <- lec_data %>% 
  filter(is.na(player_name)) %>% 
  summarise(total_deaths = sum(deaths)) %>% 
  pull()
top5_picks <- lec_data %>% 
  select(champion) %>% 
  filter(!is.na(champion)) %>% 
  group_by(champion) %>% 
  summarise(times_picked = n()) %>% 
  slice_max(times_picked, n = 5)
top5_bans <- 
  lec_data %>% 
  filter(is.na(player_name)) %>% 
  select(ban_1:ban_5) %>%
  pivot_longer(1:5, names_to = "ban_no", values_to = "champion") %>% 
  group_by(champion) %>% 
  summarise(times_banned = n()) %>% 
  slice_max(times_banned, n = 5)
```

```{r}
lec_data %>% 
  filter(is.na(player_name)) %>% 
  select(ban_1:ban_5) %>%
  pivot_longer(1:5, names_to = "ban_no", values_to = "champ") %>% 
  group_by(champ) %>% 
  summarise(times_banned = n()) %>% 
  slice_max(times_banned, n = 5)
```

```{r}
lec_data_players %>% 
  filter(team_name == "Fnatic",
         split == "Spring") %>% 
  ggplot() +
  geom_line(aes(x = date, y = deaths, group = player_name, colour = player_name)) +
  scale_x_date(date_breaks = "1 week",
               date_labels = "%d %B")
```

```{r}
lec_data_players %>% 
  filter(playoffs == TRUE,
         split == "Spring",
         player_name == "Odoamne") %>% 
  select(player_name, date)
```

```{r}
lec_data_teams %>% 
  ggplot() +
  geom_line(aes(x = game_id, y = kda, group = team_name, colour = team_name))
```

```{r}
games <- lec_data_players %>%
  filter(player_name == "Dajor") %>% 
  summarise(games_played = nrow(.)) %>% 
  pull()

wins <- lec_data_players %>% 
  filter(player_name == "Dajor") %>% 
  summarise(wins = sum(winner)) %>% 
  pull()

stats <- lec_data_players %>% 
  filter(player_name == "Dajor") %>% 
  summarise(wins = sum(winner),
            losses = nrow(.) - sum(winner),
            games_played = nrow(.),
            winrate = round((sum(winner) / nrow(.) * 100), 2))

as.list(stats)

lec_data_players %>%
  filter(player_name == "Finn" & team_deaths > 0) %>% 
  select(deaths, team_deaths) %>% 
  summarise(dpt = round(mean((deaths / team_deaths) * 100), 2))

tester <- lec_data_players %>%
  filter(player_name == "Finn") %>% 
  arrange(desc(date), desc(game)) %>% 
  slice_max(date, n = 10) %>% 
  select(date, champion, winner, kills, deaths, assists, kda, total_cs, game_length, side)

picks <- lec_data_players %>% 
  filter(player_name == "Dajor") %>% 
  group_by(champion) %>% 
  summarise(picked = n(),
            wins = sum(winner),
            losses = n() - sum(winner),
            winrate = round((sum(winner) / n()) * 100, 2),
            kills = sum(kills),
            kda = mean(kda),
            kpg = round((sum(kills) / nrow(.)), 2),
            dmg_pct = round((mean(damage_share) * 100), 2),
            g_pct = round((mean(earned_gold_share) * 100), 2)) %>% 
  arrange(desc(picked), desc(winrate))

kpt <- lec_data_players %>% 
  filter(player_name == "Dajor") %>%  
  group_by(champion) %>% 
  summarise(kpt = round(mean(((kills + assists) / team_kills) * 100), 2))

picks %>% 
  inner_join(kpt, by = "champion")

picks <- picks %>% 
  inner_join(kpt, by = champion)
```

```{r}
names <- lec_data_players %>% 
  filter(player_name == "Dajor") %>% 
  arrange(desc(date), desc(game)) %>% 
  slice_max(date, n = 10) %>% 
  select(champion) %>% 
  pull()

res = GET("https://raw.communitydragon.org/latest/plugins/rcp-be-lol-game-data/global/default/v1/champion-summary.json")

url <- fromJSON(rawToChar(res$content)) %>% 
  mutate(squarePortraitPath = str_replace_all(squarePortraitPath, "^/lol-game-data/assets", "https://raw.communitydragon.org/13.7/plugins/rcp-be-lol-game-data/global/default")) %>%
  mutate(squarePortraitPath = str_replace_all(squarePortraitPath, "^", "<img src='"),
         squarePortraitPath = str_replace_all(squarePortraitPath, "$", "' height ='200'></img>")) %>% 
  filter(name %in% names) %>% 
  select(name, squarePortraitPath)

lec_data_players %>% 
  filter(player_name == "Dajor") %>% 
  arrange(desc(date), desc(game)) %>% 
  slice_max(date, n = 10) %>% 
  select(champion) %>% 
  inner_join(url, by = c("champion" = "name"))
```

```{r}
lec_data_teams %>% 
  group_by(split, team_name) %>% 
  filter(playoffs == FALSE) %>% 
  arrange(date) %>% 
  mutate(split_wins = cumsum(winner),
         split_losses = n() - cumsum(winner), .after = split) %>% 
  select(split, team_name, wins, losses) %>% 
  filter(wins == max(wins), split == "Spring") %>% 
  arrange(desc(wins)) %>% 
  distinct()
```

```{r}
lec_data_teams %>% 
  group_by(split, team_name) %>% 
  filter(playoffs == FALSE) %>% 
  arrange(date) %>% 
  mutate(split_wins = cumsum(winner),
         split_losses = cumsum(!winner)) %>% 
  ungroup() %>% 
  group_by(team_name) %>% 
  filter((split == "Spring") & (playoffs == FALSE)) %>%  
  filter(split_wins == max(split_wins) & split_losses == max(split_losses)) %>% 
  arrange(desc(split_wins)) %>% 
  select(team_name, split_wins, split_losses) %>% 
  distinct()
```

